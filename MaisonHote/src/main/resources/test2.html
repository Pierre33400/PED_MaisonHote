<html>
  <head>
  </head>
  
  <body>
     <button id="authorize-button" onclick="handleClientLoad()">Connect to my drive</button>
     <button id="listFiles-button" onclick='getFile("house_config.json")'>Get my config file</button>
     <button id="update-button" onclick='updateFile("0B7OTPKt6x_NhSnFGdUF3cUF2NE0" , "new contennnnnt" )'>Update file</button>
     
     
     <div id="content"></div>
     
     <script type="text/javascript">
	     var clientId = '966416489314.apps.googleusercontent.com';   
	     var apiKey = 'AIzaSyD3fH3jABy0nRlFWbHqbHeh0nalgh10GzI';
	     var scopes = 'https://www.googleapis.com/auth/drive';
	     	 		 	
	     function handleClientLoad() {
	       gapi.client.setApiKey(apiKey);
	       // asks authorization do user to connect to his "google drive"
	      gapi.auth.authorize({client_id: clientId, scope: scopes, immediate: true}, killButton); 
	     }
		
	     function killButton() {
	         var authorizeButton = document.getElementById('authorize-button');
	         authorizeButton.style.visibility = 'hidden';          
	     }
			
	     function createNewFile(fileName) {
	    	gapi.client.load('drive', 'v2');
	     	var request = gapi.client.request({
	     	        'path': '/drive/v2/files',
	     	        'method': 'POST',
	     	        'body':{
	     	            "title" : fileName,
	     	            "mimeType" : "application/json",
	     	            "description" : "Config file of the guest house"	     	          
	     	         }
	     	     });
	
	     	 request.execute(function(resp) { console.log("File created : id = "+ resp.id); });	     	   
	     }
	
		    function printFileContent(fileContent){
				console.log("contenu du fichier :\n"+ fileContent);
			}

		    function downloadFile(file, callback) {
		    	  if (file.downloadUrl) {
		    	    var accessToken = gapi.auth.getToken().access_token;
		    	    var xhr = new XMLHttpRequest();
		    	    xhr.open('GET', file.downloadUrl);
		    	    xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
		    	    xhr.onload = function() {
		    	      callback(xhr.responseText);
		    	    };
		    	    xhr.onerror = function() {
		    	      callback(null);
		    	    };
		    	    xhr.send(); /*'headers': {
	    	           'Content-Type': 'multipart/mixed; boundary="' + boundary + '"'
	    	         },*/
		    	  } else {
		    	    callback(null);
		    	  }
		    	}

	       function getFile(fileName) {
		    	gapi.client.load('drive', 'v2');

	    	   // on verifie dans un premier temps que le fichier est bien présent sur le drive
	    	   var request = gapi.client.request({
	     	        'path': '/drive/v2/files',
	     	        'method': 'GET',
	     	        'params': {
	     	          q : "title='"+fileName+"'"
	     	        }	        
	     	     });	
			   request.execute(function(resp) {
				 	// cas où le fichier n'est pas présent : on le crée
					if (resp.items.length == 0) {
						console.log(fileName + ' does not exist');
						createNewFile(fileName);
					}
					// cas où le fichier existe, on telecharge son contenu
	     	  		 else {
	     		 		console.log(fileName + ' has been found : id = ' + resp.items[0].id );
						// on peut donc le récupérer
						downloadFile(resp.items[0] , printFileContent)
		     	  	 }
		       });
	       }

	       // permet de mettre à jour le fichier d'id 'fileId' avec le contenu 'newContent'
	       function updateFile(fileId, newContent) {	    	   	    	
	    	    gapi.client.load('drive', 'v2');

	    	    var request = gapi.client.request({
	    	         'path': '/upload/drive/v2/files/'+ fileId, 
	    	         'method': 'PUT',
	    	         'params': {'uploadType': 'media'},	    	        
	    	         'body': newContent});
	    	     
	    	     request.execute(function(resp){
						console.log(resp) ;
		    	     });	    	   
	    	 }
	    	 
	     </script>
	     <!-- <script src="https://apis.google.com/js/client.js?onload=handleClientLoad"></script> -->
	     <script src="https://apis.google.com/js/client.js"></script>
  </body>
</html>